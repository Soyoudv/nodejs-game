<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>test D3.js</title>
</head>
<script src="/socket.io/socket.io.js"></script>
<script src="https://d3js.org/d3.v7.min.js"></script>

<style>
 
    body {
        background-color: #222;
        color: #fff;
        font-family: "MS UI Gothic", sans-serif;
    }

</style>

<body>
    <p>Test D3.js</p>
    <svg id="svg1" width="10000" height="10000" style="border:1px solid white">
        
    </svg>
</body>

<script>
    const socket = io();

    var n_books = 0;

    function tailleDynamique(size, title) { // fonction pour calculer la taille de police en fonction de la longueur du titre
        const max = size * 0.13;                 // taille maxi relative
        const min = size * 0.06;                 // taille mini relative
        const penalty = title.length * (size * 0.002);

        return Math.max(min, max - penalty);
    }

    function wrapText(textSelection, width) { // fonction compliquée pour coupe le texte en plusieurs lignes si trop long
        textSelection.each(function () {
            const text = d3.select(this);
            const words = text.text().split(/\s+/).reverse();
            let word;
            let line = [];
            let lineNumber = 0;
            const lineHeight = 1.1; //en em
            const y = text.attr("y");
            const dy = 0;

            let tspan = text.text(null)
            .append("tspan")
            .attr("x", text.attr("x"))
            .attr("y", y)
            .attr("dy", dy + "em");

            while (word = words.pop()) {
                line.push(word);
                tspan.text(line.join(" "));
                if (tspan.node().getComputedTextLength() > width) {
                    line.pop();
                    tspan.text(line.join(" "));
                    line = [word];
                    if (++lineNumber > 1) break; // max 2 lignes
                    tspan = text.append("tspan")
                    .attr("x", text.attr("x"))
                    .attr("y", y)
                    .attr("dy", lineNumber * lineHeight + dy + "em")
                    .text(word);
                }
            }
        });
    }

    function matchCouleurGenre(genre){ // fonction pour associer une couleur à un genre
        const couleurs = { // que des couleurs différentes pour bien voir
            "anglo-saxonne": "brown",
            "aventures": "green",
            "essai": "purple",
            "fantasy": "dark_green",
            "feelgood": "orange",
            "humour": "yellow",
            "poésie": "lime",
            "policier": "blue",
            "roman": "pink",
            "russe": "cyan",
            "sf": "dark_blue",
            "théâtre": "red",
            "thriller": "dark_red"
        };
        return couleurs[genre] || "gray"; // Couleur par défaut si le genre n'est pas reconnu
    }

    function matchCouleurFormat(format){ // fonction pour associer une couleur à un format
        const couleurs = {
            "grand": "#ffffff",
            "maxi": "#FFF9ED",
            "medium": "#FFF3F2",
            "poche": "#FFE9D6"
        };
        return couleurs[format] || "gray"; // Couleur par défaut si le format n'est pas reconnu
    }

    const drag = d3.drag()
    .on("start", function (event, d) {
        d3.select(this).raise(); // met le livre au-dessus des autres
    })
    .on("drag", function (event, d) {
        d.x = event.x;
        d.y = event.y;

        d3.select(this)
        .attr("transform", `translate(${d.x}, ${d.y})`);
    })
    .on("end", function (event, d) {
        console.log("Livre déplacé :", d.id, d.x, d.y);
    });

    function afficher_livre(book, index, size) {
        const w = size*(0.75);
        const h = size;
        const x = 10 + size * (index - Math.floor(n_books / 10) * 10 - 1);
        const y = 10 + Math.floor(n_books / 10) * (size + 10);
        const imgSize = size * 0.5;

        const couleurGenre = matchCouleurGenre(book.genre);
        const couleurFormat = matchCouleurFormat(book.format);
        
        const fontSize = tailleDynamique(size, book.titre); //taille de police dynamique en fonction de la longueur du titre

        const bookGroup = d3.select("#svg1")
        .append("g")
        .attr("class", "book")
        .attr("transform", `translate(${x}, ${y})`)
        .datum({
            book, x, y
        });

        bookGroup.append("rect")
        .attr("width", w)
        .attr("height", h)
        .attr("fill", couleurFormat)

        bookGroup.append("text")
        .attr("id", "nom")
        .attr("x", w / 2)
        .attr("y", w*0.15)
        .attr("text-anchor", "middle")
        .attr("fill", "black")
        .attr("font-weight", "bold")
        .attr("font-size", `${fontSize}px`)
        .text(book.nom || book.auteur); // nom de l'auteur, s'il est vide, mettre l'auteur

        bookGroup.append("text")
        .attr("id", "titre")
        .attr("x", w / 2)
        .attr("y", w*0.3)
        .attr("text-anchor", "middle")
        .attr("fill", "black")
        .attr("font-size", `${fontSize}px`)
        .text(book.titre);

        bookGroup.append("rect")
        .attr("width", imgSize)
        .attr("height", imgSize)
        .attr("x", (w - imgSize) / 2)
        .attr("y", h - imgSize - 10)
        .attr("fill", couleurGenre);

        wrapText(bookGroup.select("#titre"), w - 8);

        d3.selectAll(".book").call(drag);
    }

    socket.on("book", (book, index) => {
        console.log("Received book:", book, " at index:", index);
        const size = 150;
        afficher_livre(book, index, size);
        n_books += 1;
    });

</script>
</html>